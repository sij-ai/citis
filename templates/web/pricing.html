{% extends "base.html" %}

{% block title %}Pricing - cit.is{% endblock %}

{% block content %}
<style>
    /* Simple styling to make key sections stand out */
    .pricing-table .card {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .pricing-table .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,.15);
    }
    .key-feature {
        background-color: rgba(128, 128, 128, 0.05);
        border: 1px solid rgba(128, 128, 128, 0.1);
        border-radius: .25rem;
        padding: 0.75rem;
        margin-top: 1rem;
        font-size: 0.9em;
    }
    .key-feature strong {
        display: block;
        margin-bottom: 0.25rem;
        color: var(--text-normal, #e0e0e0); /* Use your theme's text color */
    }
    
    /* Feature sections styling */
    .feature-sections {
        margin: 1.5rem 0;
    }
    
    .feature-section {
        margin-bottom: 1.25rem;
    }
    
    .feature-section:last-child {
        margin-bottom: 0;
    }
    
    .feature-section-header {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-subtle);
        margin-bottom: 0.5rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid rgba(128, 128, 128, 0.1);
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    
    .feature-section-header i {
        opacity: 0.7;
        font-size: 0.8rem;
    }
    
    .feature-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .feature-list li {
        padding: 0.35rem 0;
        font-size: 0.9rem;
        line-height: 1.4;
        border-bottom: 1px solid rgba(128, 128, 128, 0.05);
    }
    
    .feature-list li:last-child {
        border-bottom: none;
    }
</style>

<div class="container my-5">
    <!-- Logo -->
    <div class="row">
        <div class="col-12 text-center mb-4">
            <div style="padding: 1.5rem 0;">
                <img src="/static/citis-pixelart.png" 
                     alt="cit.is Logo" 
                     class="logo"
                     style="image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges; width: auto; height: 50px; opacity: 0.9;">
            </div>
        </div>
    </div>
    
    <!-- Header -->
    <div class="row">
        <div class="col-lg-8 mx-auto text-center mb-5">
            <h1 class="display-5 fw-bold">Find Your Plan</h1>
            <p class="lead" style="color: var(--text-subtle);">
                Choose the plan that fits your archiving needs. Start free and upgrade as you grow.
            </p>
        </div>
    </div>
    
    <!-- Pricing Cards -->
    <div class="row g-4 justify-content-center pricing-table">

        <!-- Free Plan -->
        <div class="col-lg-4 d-flex">
            <div class="card h-100 w-100 border-0 d-flex flex-column">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="text-center mb-2">
                        <h3 class="h4 fw-bold">Free</h3>
                        <p class="mb-2" style="color: var(--text-subtle);">For students, hobbyists, and light use.</p>
                    </div>

                    <!-- Link Permanence Feature -->
                    <div class="key-feature">
                        <strong>Our Promise:</strong>
                        <p class="mb-0" style="color: var(--text-muted);">Artifacts will be hosted on cit.is for at least 3 years. After that, we may ask you to upgrade to preserve older archives.</p>
                    </div>

                    <!-- Feature Categories -->
                    <div class="feature-sections">
                        <!-- Usage & Limits -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-speedometer2 me-2"></i>Usage & Limits
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span><strong>5</strong> New Archives / Month (+<strong>20</strong> for students!)</li>
                                <li><span class="me-2">&#10003;</span><strong>25</strong> New Redirects / Month</li>
                                <li><span class="me-2">&#10003;</span><strong>5MB</strong> Max Archive Size</li>
                                <li><span class="me-2">&#10003;</span><strong>8</strong> random character shortlinks</li>
                            </ul>
                        </div>

                        <!-- Monitoring & Health -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-activity me-2"></i>Monitoring & Health
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span>Link Health Check (<strong>1-day</strong> interval)</li>
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>Content Integrity Scan</li>
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>Periodic Re-Archival</li>
                            </ul>
                        </div>

                        <!-- Advanced Tools -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-tools me-2"></i>Advanced Tools
                            </h6>
                            <ul class="feature-list">
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>Device Simulation</li>
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>Proxy Access</li>
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>API Access</li>
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>Full-Text Search</li>
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>Analytics</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Trust Feature -->
                    <div class="key-feature">
                        <strong>Trust: Basic Proof</strong>
                        <p class="mb-0" style="color: var(--text-muted);">Every archive includes a SHA256 checksum so anyone can verify its integrity.</p>
                    </div>
                    
                    <div class="mt-4 pt-3 border-top border-secondary border-opacity-25">
                        <p class="text-center mb-0" style="color: var(--text-muted);">Support: Self-Help Forums (coming soon)</p>
                    </div>

                    <div class="mt-auto pt-4">
                        {% if user_is_authenticated %}
                            {% if user.is_superuser %}
                                <span class="btn btn-outline-warning w-100" style="cursor: default;">
                                    <i class="bi bi-shield-fill-check me-2"></i>
                                    Administrator Account
                                </span>
                            {% elif user_current_plan == 'free' and not user_is_premium %}
                                <span class="btn btn-outline-secondary w-100" style="cursor: default;">
                                    Current Plan
                                </span>
                            {% else %}
                                <button class="btn btn-outline-secondary w-100" disabled>
                                    Not Available
                                </button>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'account_signup' %}" class="btn btn-outline-primary w-100">Get Started Free</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Professional Plan -->
        <div class="col-lg-4 d-flex">
            <div class="card h-100 w-100 border-primary position-relative d-flex flex-column" style="border-width: 2px;">
                <div class="position-absolute top-0 start-50 translate-middle">
                    <span class="badge rounded-pill px-3 py-2" style="background-color: var(--accent-cyan); color: var(--bg-primary); font-weight: 600;">Most Popular</span>
                </div>
                <div class="card-body p-4 d-flex flex-column">
                    <div class="text-center mb-2">
                        <h3 class="h4 fw-bold">Professional</h3>
                        <p class="mb-2" style="color: var(--text-subtle);">For researchers, journalists, and professionals.</p>
                    </div>

                    <!-- Link Permanence Feature -->
                    <div class="key-feature">
                        <strong>Our Guarantee:</strong>
                        <p class="mb-0" style="color: var(--text-muted);">Artifacts will be hosted on cit.is for the life of your subscription, plus a 3-year grace period.</p>
                    </div>

                    <!-- Feature Categories -->
                    <div class="feature-sections">
                        <!-- Usage & Limits -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-speedometer2 me-2"></i>Usage & Limits
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span><strong>100</strong> New Archives / Month</li>
                                <li><span class="me-2">&#10003;</span><strong>250</strong> New Redirects / Month</li>
                                <li><span class="me-2">&#10003;</span><strong>25MB</strong> Max Archive Size</li>
                                <li><span class="me-2">&#10003;</span><strong>6</strong> random characters (<strong>5</strong> for first <strong>1k</strong>!) + Custom slugs</li>
                            </ul>
                        </div>

                        <!-- Monitoring & Health -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-activity me-2"></i>Monitoring & Health
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span>Link Health Check (<strong>5-minute</strong> interval)</li>
                                <li><span class="me-2">&#10003;</span>Content Integrity Scan (<strong>1-hour</strong> interval)</li>
                                <li style="color: var(--text-subtle);"><span class="me-2">&times;</span>Periodic Re-Archival</li>
                            </ul>
                        </div>

                        <!-- Advanced Tools -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-tools me-2"></i>Advanced Tools
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span>Device Simulation (Desktop & Mobile)</li>
                                <li><span class="me-2">&#10003;</span>Residential Proxy Access</li>
                                <li><span class="me-2">&#10003;</span>API Access</li>
                                <li><span class="me-2">&#10003;</span>Full-Text Search</li>
                                <li><span class="me-2">&#10003;</span>Basic Analytics</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Trust Feature -->
                    <div class="key-feature">
                        <strong>Trust: Time Proof</strong>
                        <p class="mb-0" style="color: var(--text-muted);">In addition to checksums, every archive gets a trusted timestamp, creating a verifiable digital artifact.</p>
                    </div>

                    <div class="mt-4 pt-3 border-top border-secondary border-opacity-25">
                        <p class="text-center mb-0" style="color: var(--text-muted);">Support: Standard Support (Email)</p>
                    </div>

                    <div class="mt-auto pt-4">
                        {% if user_is_authenticated %}
                            {% if user.is_superuser %}
                                <span class="btn btn-outline-warning w-100" style="cursor: default;">
                                    <i class="bi bi-shield-fill-check me-2"></i>
                                    Administrator Account
                                </span>
                            {% elif user_current_plan == 'professional' or user_is_premium %}
                                <span class="btn btn-success w-100" style="cursor: default;">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Current Plan
                                </span>
                            {% elif user_current_plan == 'sovereign' %}
                                <span class="btn btn-outline-secondary w-100" style="cursor: default;">
                                    <i class="bi bi-crown-fill me-2"></i>
                                    Higher Plan Active
                                </span>
                            {% else %}
                                <button class="btn btn-primary w-100" onclick="subscribeToProfessional()">
                                    Upgrade to Professional - $10/mo
                                </button>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'account_signup' %}" class="btn btn-primary w-100">Start Professional - $10/mo</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sovereign Plan -->
        <div class="col-lg-4 d-flex">
            <div class="card h-100 w-100 border-0 d-flex flex-column">
                <div class="card-body p-4 d-flex flex-column">
                    <div class="text-center mb-2">
                        <h3 class="h4 fw-bold">Sovereign</h3>
                        <p class="mb-2" style="color: var(--text-subtle);">For law firms, newsrooms, and enterprises.</p>
                    </div>

                    <!-- Link Permanence Feature -->
                    <div class="key-feature">
                        <strong>Your Freedom:</strong>
                        <p class="mb-0" style="color: var(--text-muted);">By connecting a custom domain, your links can outlive us via our portable open source platform.</p>
                    </div>

                    <!-- Feature Categories -->
                    <div class="feature-sections">
                        <!-- Usage & Limits -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-speedometer2 me-2"></i>Usage & Limits
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span>Usage based pricing</li>
                                <li><span class="me-2">&#10003;</span>Unlimited archives, redirects, file size</li>
                                <li><span class="me-2">&#10003;</span><strong>5</strong> random characters (or any length) + Custom slugs</li>
                                <li><span class="me-2">&#10003;</span>Custom domain support</li>
                            </ul>
                        </div>

                        <!-- Monitoring & Health -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-activity me-2"></i>Monitoring & Health
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span>Link Health Check (Real-time)</li>
                                <li><span class="me-2">&#10003;</span>Content Integrity Scan (<strong>5-minute</strong> interval)</li>
                                <li><span class="me-2">&#10003;</span>Periodic Re-Archival</li>
                            </ul>
                        </div>

                        <!-- Advanced Tools -->
                        <div class="feature-section">
                            <h6 class="feature-section-header">
                                <i class="bi bi-tools me-2"></i>Advanced Tools
                            </h6>
                            <ul class="feature-list">
                                <li><span class="me-2">&#10003;</span>Advanced Device Simulation & Capture</li>
                                <li><span class="me-2">&#10003;</span>Global & Custom Proxy Access</li>
                                <li><span class="me-2">&#10003;</span>API Access</li>
                                <li><span class="me-2">&#10003;</span>Full-Text Search</li>
                                <li><span class="me-2">&#10003;</span>Advanced Analytics</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Trust Feature -->
                    <div class="key-feature">
                        <strong>Trust: Legal Proof</strong>
                        <p class="mb-0" style="color: var(--text-muted);">Multi-source verification, commercial timestamping, full chain-of-custody report, and optional legal consultation.</p>
                    </div>

                    <div class="mt-4 pt-3 border-top border-secondary border-opacity-25">
                        <p class="text-center mb-0" style="color: var(--text-muted);">Support: Dedicated Priority (Phone, Chat, Email)</p>
                    </div>

                    <div class="mt-auto pt-4">
                        {% if user_is_authenticated %}
                            {% if user.is_superuser %}
                                <span class="btn btn-outline-warning w-100" style="cursor: default;">
                                    <i class="bi bi-shield-fill-check me-2"></i>
                                    Administrator Account
                                </span>
                            {% elif user_current_plan == 'sovereign' %}
                                <span class="btn btn-success w-100" style="cursor: default;">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Current Plan
                                </span>
                            {% elif user_is_premium or user_current_plan == 'professional' %}
                                <button class="btn btn-outline-secondary w-100" onclick="openBillingPortal()">
                                    <i class="bi bi-gear me-2"></i>
                                    Manage Subscription
                                </button>
                            {% else %}
                                <a href="mailto:{{ sales_email }}" class="btn btn-outline-primary w-100">Contact Sales</a>
                            {% endif %}
                        {% else %}
                            <a href="mailto:{{ sales_email }}" class="btn btn-outline-primary w-100">Contact Sales</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ Section -->
    <div class="row mt-5 pt-5">
        <div class="col-lg-8 mx-auto">
            <h2 class="text-center mb-4">Frequently Asked Questions</h2>
            <div class="accordion" id="pricingFAQ">
                <!-- FAQ Item 1 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                            What is an "archive" or "artifact"? Is it just a screenshot?
                        </button>
                    </h2>
                    <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            An artifact is much more than a screenshot. It is a fully interactive, self-contained HTML file. All the necessary CSS, fonts, and images are embedded directly into the file, so it looks and functions just like the original page, but can be viewed offline and will not change. You can select text, click (most) links, and interact with the content.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 2 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                            What's the difference between "Link Health Check" and "Content Integrity Scan"?
                        </button>
                    </h2>
                    <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            A <strong>Link Health Check</strong> simply verifies if the original URL is still online (e.g., not a 404 error). A <strong>Content Integrity Scan</strong> is much more powerful: it re-downloads the page and performs a comparison to see if the text or images have been meaningfully altered since you archived it.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 3 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                            What is a "Trusted Timestamp"?
                        </button>
                    </h2>
                    <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            For our Professional and Sovereign plans, we use a third-party, cryptographically secure timestamping authority (TSA). This creates a verifiable, independent record proving that your archived content existed in a specific state at a specific point in time, which is crucial for legal and academic integrity.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 4 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                           Why would I need a proxy to archive a public page?
                        </button>
                    </h2>
                    <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            Many modern websites serve different content based on the visitor's geographic location or block traffic from known datacenter IP addresses (like ours). Using a residential proxy allows our archiver to view the page exactly as a normal user from a specific country would, ensuring a high-fidelity capture of the correct content.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 5 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq5">
                           Can I use my own domain?
                        </button>
                    </h2>
                    <div id="faq5" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                           Yes! Custom domain support is a core feature of our Sovereign plan. This allows you to brand your archived links (e.g., `archive.yourcompany.com/ABC`) and provides a path to keep your links alive even if the cit.is service were to cease operations, ensuring true data sovereignty.
                        </div>
                    </div>
                </div>
                 <!-- FAQ Item 6 -->
                 <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq6">
                           What does "data sovereignty" mean for the Sovereign plan?
                        </button>
                    </h2>
                    <div id="faq6" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            It means you are in ultimate control. By using your own domain, you own the links themselves. If you ever decide to leave our service, you can use our open-source platform to host your archived artifacts on your own infrastructure without breaking any of your existing links. Your data is never locked in.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 7 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq7">
                           Can a cit.is archive be used as legal evidence?
                        </button>
                    </h2>
                    <div id="faq7" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            While cit.is is designed to meet high standards for evidentiary integrity, admissibility is determined by courts on a case-by-case basis. Our Sovereign plan provides a "Full Forensic Package"—including checksums, trusted timestamps, and chain-of-custody reports—to provide the strongest possible technical foundation for your legal arguments. We cannot offer legal advice, but we can provide the tools to support your case.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 8 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq8">
                           How do I qualify for the student bonus?
                        </button>
                    </h2>
                    <div id="faq8" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            Simply sign up with a valid email address from an educational institution (e.g., `.edu`, `.ac.uk`). The bonus archive quota will be applied to your account automatically.
                        </div>
                    </div>
                </div>
                <!-- FAQ Item 9 -->
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq9">
                           What are the limitations? Can I archive videos or paywalled content?
                        </button>
                    </h2>
                    <div id="faq9" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            cit.is archives the content of a web page—text, images, and layout. It cannot archive streaming video or audio content (though it will capture the player and surrounding text). The service is designed for publicly accessible pages. Archiving content behind a paywall or login screen is not supported at this time.
                        </div>
                    </div>
                </div>
                 <!-- FAQ Item 10 -->
                 <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq10">
                           What if I need more than the Professional plan offers but don't need the full Sovereign plan?
                        </button>
                    </h2>
                    <div id="faq10" class="accordion-collapse collapse" data-bs-parent="#pricingFAQ">
                        <div class="accordion-body">
                            We understand that needs vary. If your usage exceeds the Professional plan limits, please contact us. We can often create custom "Pro Plus" plans with higher quotas for power users, small teams, and organizations that don't yet require the full suite of Sovereign features.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if user_is_authenticated %}
<script>
function subscribeToProfessional() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Processing...';
    
    // Create checkout session
    fetch('{% url "web:create_checkout_session" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: 'price_id=premium_monthly'
    })
    .then(response => response.json())
    .then(data => {
        if (data.checkout_url) {
            // Redirect to Stripe checkout
            window.location.href = data.checkout_url;
        } else {
            // Show user-friendly error message
            const errorMessage = data.error || 'Failed to create checkout session';
            
            // Log technical details for developers
            if (data.dev_error) {
                console.error('Developer Error:', data.dev_error);
            }
            
            throw new Error(errorMessage);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Show appropriate error message
        let errorMessage = 'There was an error processing your subscription. Please try again.';
        if (error.message && error.message !== 'Failed to fetch') {
            errorMessage = error.message;
        }
        
        showErrorToast(errorMessage);
        
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function openBillingPortal() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="spinner-border spinner-border-sm me-2"></i>Loading...';
    
    fetch('{% url "web:billing_portal" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.portal_url) {
            // Redirect to Stripe billing portal
            window.location.href = data.portal_url;
        } else {
            // Show user-friendly error message
            const errorMessage = data.error || 'Failed to access billing portal';
            
            // Log technical details for developers
            if (data.dev_error) {
                console.error('Developer Error:', data.dev_error);
            }
            
            throw new Error(errorMessage);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Show appropriate error message
        let errorMessage = 'There was an error accessing the billing portal. Please try again.';
        if (error.message && error.message !== 'Failed to fetch') {
            errorMessage = error.message;
        }
        
        showErrorToast(errorMessage);
        
        // Restore button state
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

// Toast notification functions
function showErrorToast(message) {
    showToast(message, 'danger', 'Error');
}

function showSuccessToast(message) {
    showToast(message, 'success', 'Success');
}

function showToast(message, type, title) {
    // Create toast element
    const toastId = 'toast-' + Date.now();
    const toastHtml = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-header bg-${type} text-white">
                <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                <strong class="me-auto">${title}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    // Add to container or create one
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.style.zIndex = '1055';
        document.body.appendChild(container);
    }
    
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    // Show the toast
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove from DOM after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}
</script>
{% endif %}
{% endblock %}
